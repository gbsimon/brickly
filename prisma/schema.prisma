generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String     @id
  email     String?    @unique
  name      String?
  image     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  progress  Progress[]
  sets      Set[]

  @@map("users")
}

model Set {
  userId       String
  setNum       String
  name         String
  year         Int
  numParts     Int
  imageUrl     String?
  themeId      Int
  themeName    String?
  isOngoing    Boolean    @default(false)
  isHidden     Boolean    @default(false)
  addedAt      DateTime   @default(now())
  lastOpenedAt DateTime   @default(now())
  inventory    Inventory?
  progress     Progress[]
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, setNum])
  @@index([userId])
  @@index([userId, lastOpenedAt])
  @@index([userId, isOngoing])
  @@index([userId, isHidden])
  @@index([userId, themeId])
  @@map("sets")
}

model Inventory {
  userId    String
  setNum    String
  parts     Json
  fetchedAt DateTime @default(now())
  set       Set      @relation(fields: [userId, setNum], references: [userId, setNum], onDelete: Cascade)

  @@id([userId, setNum])
  @@map("inventories")
}

model CachedSet {
  setNum    String   @id
  data      Json
  fetchedAt DateTime @default(now())

  @@index([fetchedAt])
  @@map("cached_sets")
}

model CachedInventory {
  setNum    String   @id
  parts     Json
  minifigs  Json?
  fetchedAt DateTime @default(now())

  @@index([fetchedAt])
  @@map("cached_inventories")
}

model Progress {
  id        String   @id @default(uuid())
  userId    String
  setNum    String
  partNum   String
  colorId   Int
  isSpare   Boolean  @default(false)
  neededQty Int
  foundQty  Int      @default(0)
  updatedAt DateTime @default(now()) @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  set       Set      @relation(fields: [userId, setNum], references: [userId, setNum], onDelete: Cascade)

  @@unique([userId, setNum, partNum, colorId, isSpare])
  @@index([userId, setNum])
  @@map("progress")
}
